name: Update Streak Card

on:
  schedule:
    - cron: "0 6 * * *"      # 06:00 UTC diariamente
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-streak:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout completo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0                   # necessÃ¡rio para pull/rebase

      - name: Configurar Git e remote com token
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # ðŸ”‘ garanta que o 'origin' jÃ¡ use o token (evita push por URL avulsa)
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"

      - name: Sincronizar branch main
        run: |
          git checkout main || echo "JÃ¡ na main"
          git fetch origin main
          git pull --rebase origin main     # fica 100% alinhado com o remoto

      - name: Criar pasta assets
        run: mkdir -p assets

      - name: Baixar streak card (SVG)
        run: |
          curl -fL --retry 3 --connect-timeout 10 \
            "https://streak-stats.demolab.com?user=CaioGitHub&theme=tokyonight&hide_border=true" \
            -o assets/streak.svg

      - name: Commit e push apenas se mudou
        run: |
          # sÃ³ commitar se o arquivo realmente mudou
          if ! git diff --quiet -- assets/streak.svg; then
            git add assets/streak.svg
            git commit -m "chore: update streak card"
            # ðŸ’¡ agora o lease funciona, pois empurramos para o *remote* origin
            git push --force-with-lease origin HEAD:main
            echo "âœ… AtualizaÃ§Ã£o enviada com sucesso!"
          else
            echo "âœ… Sem alteraÃ§Ãµes reais no streak.svg"
          fi
