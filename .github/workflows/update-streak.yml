name: Update Streak Card

on:
  schedule:
    - cron: "0 6 * * *"      # 06:00 UTC = 03:00 no Brasil
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-streak:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout completo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configurar Git e remote com token
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"

      - name: Sincronizar branch main
        run: |
          git checkout main || echo "JÃ¡ na main"
          git fetch origin main
          git pull --rebase origin main

      - name: Criar pasta assets
        run: mkdir -p assets

      - name: Baixar streak card (SVG)
        run: |
          curl -fL --retry 3 --connect-timeout 10 \
            "https://streak-stats.demolab.com?user=CaioGitHub&theme=tokyonight&hide_border=true" \
            -o assets/streak.svg

      - name: Atualizar badge de Ãºltima atualizaÃ§Ã£o no README
        run: |
          DATE=$(TZ="America/Sao_Paulo" date '+%d/%m/%Y %H:%M')
          BADGE="![Ãšltima atualizaÃ§Ã£o](https://img.shields.io/badge/ðŸ•’%20Ãšltima%20atualizaÃ§Ã£o-${DATE// /%20}-(BrasÃ­lia)-blue?style=for-the-badge)"
          
          # Substitui a linha da badge no README (ou adiciona se nÃ£o existir)
          if grep -q "Ãšltima atualizaÃ§Ã£o" README.md; then
            sed -i "s|!\[Ãšltima atualizaÃ§Ã£o\].*|$BADGE|" README.md
          else
            echo -e "\n---\n\n$BADGE" >> README.md
          fi

      - name: Commit e Push se houver alteraÃ§Ãµes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if ! git diff --quiet; then
            DATE=$(TZ="America/Sao_Paulo" date '+%d/%m/%Y %H:%M')
            git add assets/streak.svg README.md
            git commit -m "ðŸ“ˆ Atualizando streak diÃ¡rio - ${DATE} (BrasÃ­lia)"
            git push --force-with-lease origin HEAD:main
            echo "âœ… AtualizaÃ§Ã£o enviada com sucesso!"
          else
            echo "âœ… Sem alteraÃ§Ãµes reais no streak.svg ou README.md"
          fi
