name: Update Streak Card

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-streak:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout completo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configurar Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Atualizar branch local
        run: |
          git fetch origin main
          git rebase origin/main || git rebase --abort
          echo "‚úÖ Branch sincronizada com origin/main"

      - name: Criar pasta assets
        run: mkdir -p assets

      - name: Baixar streak card atualizado (SVG)
        run: |
          curl -fL --retry 3 --connect-timeout 10 \
            "https://streak-stats.demolab.com?user=CaioGitHub&theme=tokyonight&hide_border=true" \
            -o assets/streak.svg

      - name: Commit e Push se houver altera√ß√µes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git add assets/streak.svg
            git commit -m "chore: update streak card"

            echo "üöÄ Enviando atualiza√ß√£o para o GitHub..."
            git fetch origin main
            git rebase origin/main || echo "‚ö†Ô∏è Nenhum rebase necess√°rio"
            
            # üöÄ Push for√ßado com seguran√ßa
            git push --force-with-lease "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" HEAD:main
            
            echo "‚úÖ Atualiza√ß√£o enviada com sucesso!"
          else
            echo "‚úÖ Sem altera√ß√µes a serem commitadas"
          fi

